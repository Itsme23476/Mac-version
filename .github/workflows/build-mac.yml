name: Build macOS App

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.9.0)'
        required: false
        default: ''

# Grant write permissions for uploading to releases
permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r ai_file_organizer/requirements.txt
      
      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Remove 'v' or 'V' prefix and any leading dots
            VERSION=$(echo "$VERSION" | sed 's/^[vV]//; s/^\.//')
          else
            # Use sed instead of grep -P (macOS compatible)
            VERSION=$(sed -n 's/.*VERSION = "\([^"]*\)".*/\1/p' ai_file_organizer/app/version.py | head -1)
            if [ -z "$VERSION" ]; then
              VERSION="1.0.0"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Update version.py with release version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Updating version.py to version: $VERSION"
          
          # Update VERSION in version.py
          sed -i '' "s/^VERSION = .*/VERSION = \"$VERSION\"/" ai_file_organizer/app/version.py
          
          # Update BUILD_DATE
          BUILD_DATE=$(date +%Y-%m-%d)
          sed -i '' "s/^BUILD_DATE = .*/BUILD_DATE = \"$BUILD_DATE\"/" ai_file_organizer/app/version.py
          
          # Verify the update
          echo "Updated version.py:"
          cat ai_file_organizer/app/version.py
      
      - name: Build with PyInstaller
        run: |
          cd ${{ github.workspace }}
          python -m PyInstaller --clean --noconfirm Lumina.spec
      
      - name: Verify build
        run: |
          if [ ! -d "dist/Lumina.app" ]; then
            echo "Error: Lumina.app was not created"
            ls -la dist/ || echo "dist folder doesn't exist"
            exit 1
          fi
          echo "Build successful!"
          du -sh dist/Lumina.app
      
      - name: Create DMG
        run: |
          # Install create-dmg
          brew install create-dmg || true
          
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME="Lumina-${VERSION}-mac"
          
          # Create DMG
          create-dmg \
            --volname "Lumina $VERSION" \
            --volicon "ai_file_organizer/resources/icon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Lumina.app" 150 190 \
            --hide-extension "Lumina.app" \
            --app-drop-link 450 185 \
            "dist/${DMG_NAME}.dmg" \
            "dist/Lumina.app" || {
              # Fallback to hdiutil if create-dmg fails
              echo "create-dmg failed, using hdiutil..."
              mkdir -p dist/dmg_temp
              cp -R dist/Lumina.app dist/dmg_temp/
              ln -s /Applications dist/dmg_temp/Applications
              hdiutil create -volname "Lumina $VERSION" \
                -srcfolder dist/dmg_temp \
                -ov -format UDZO \
                "dist/${DMG_NAME}.dmg"
              rm -rf dist/dmg_temp
            }
          
          echo "DMG created:"
          ls -la dist/*.dmg
      
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Lumina-mac-dmg
          path: dist/*.dmg
          retention-days: 30
      
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.dmg
      
      - name: Update Supabase app_version
        if: github.event_name == 'release'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          DMG_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/Lumina-${VERSION}-mac.dmg"
          
          echo "Updating Supabase with Mac download URL..."
          echo "Version: ${VERSION}"
          echo "DMG URL: ${DMG_URL}"
          
          # Check if version already exists
          EXISTING=$(curl -s "${SUPABASE_URL}/rest/v1/app_version?version=eq.${VERSION}" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}")
          
          if [ "$EXISTING" = "[]" ]; then
            # Insert new version
            echo "Inserting new version record..."
            curl -X POST "${SUPABASE_URL}/rest/v1/app_version" \
              -H "apikey: ${SUPABASE_SERVICE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
              -H "Content-Type: application/json" \
              -d "{
                \"version\": \"${VERSION}\",
                \"download_url\": \"${DMG_URL}\",
                \"download_url_mac\": \"${DMG_URL}\",
                \"release_name\": \"${RELEASE_NAME:-Lumina ${VERSION}}\",
                \"release_notes\": \"macOS release ${VERSION}\",
                \"published_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
                \"is_required\": false
              }"
          else
            # Update existing version with Mac URL
            echo "Updating existing version with Mac URL..."
            curl -X PATCH "${SUPABASE_URL}/rest/v1/app_version?version=eq.${VERSION}" \
              -H "apikey: ${SUPABASE_SERVICE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
              -H "Content-Type: application/json" \
              -d "{
                \"download_url_mac\": \"${DMG_URL}\"
              }"
          fi
          
          echo "Supabase update complete!"
